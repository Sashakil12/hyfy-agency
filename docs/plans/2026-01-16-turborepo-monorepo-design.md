# Turborepo Monorepo Design

**Date:** 2026-01-16
**Project:** hyfy-agency monorepo setup

## Overview

A Turborepo-based monorepo containing an Astro frontend, Strapi headless CMS, and reusable TypeScript packages. The Astro site will feature a blog page that consumes content from Strapi via its API.

## Technology Stack

- **Monorepo tool:** Turborepo
- **Package manager:** pnpm
- **Frontend:** Astro with React integration
- **CMS:** Strapi v4 with TypeScript
- **Database:** SQLite (dev), Postgres/MySQL (production)
- **Shared packages:** React UI components, TypeScript utilities
- **Tooling:** ESLint, Prettier, Vitest, TypeScript

---

## 1. Monorepo Structure

```
hyfy-agency/
├── apps/
│   ├── web/                 # Astro frontend
│   └── strapi/              # Strapi CMS
├── packages/
│   ├── ui/                  # React components (@repo/ui)
│   ├── utils/               # TypeScript utilities (@repo/utils)
│   ├── eslint-config/       # Shared ESLint config (@repo/eslint-config)
│   ├── typescript-config/   # Shared TS configs (@repo/typescript-config)
│   └── vitest-config/       # Shared Vitest config (@repo/vitest-config)
├── docs/
│   └── plans/               # Design docs and planning
├── package.json             # Root workspace config
├── pnpm-workspace.yaml      # pnpm workspace definition
├── turbo.json              # Turborepo pipeline config
├── .prettierrc             # Prettier formatting
└── .gitignore
```

**Rationale:**

- `apps/` for deployable applications
- `packages/` for reusable shared code
- Tooling packages ensure consistency across all packages

---

## 2. Astro Frontend App (`apps/web`)

**Framework setup:**

- Astro with React integration enabled for shared UI components
- TypeScript for type safety
- Content collections for local content management (if needed)

**Key features:**

- Landing page and static pages using Astro components
- `/blog` route that fetches posts from Strapi API
- React islands for interactive UI components from `@repo/ui`
- API routes in `src/pages/api/` if server-side logic needed

**Dependencies:**

- Internal: `@repo/ui`, `@repo/utils`, `@repo/typescript-config`
- External: `astro`, `@astrojs/react`, `react`, `react-dom`

**Build output:**

- Static site generation (SSG) by default
- Option to use hybrid rendering if certain pages need server-side rendering (SSR)

**API integration:**

- Imports types and utilities from `@repo/utils` to interact with Strapi's API
- Centralized API client logic for consistency

---

## 3. Strapi CMS App (`apps/strapi`)

**Setup:**

- Strapi v4 (latest stable version)
- SQLite database for local development
- Environment-based database config (SQLite dev, Postgres/MySQL production)
- TypeScript enabled

**Content structure:**

- Blog post content type with fields:
  - title, slug, content (rich text)
  - excerpt, publishedAt, author
  - featuredImage, categories/tags
- API endpoints automatically generated by Strapi
- Configurable permissions for public read access to published posts

**Key customizations:**

- Custom API routes in `src/api/` if needed
- Strapi admin panel accessible at `http://localhost:1337/admin`
- Media library for uploading images

**Dependencies:**

- Internal: `@repo/typescript-config`
- External: `@strapi/strapi`, `@strapi/plugin-users-permissions`, SQLite/better-sqlite3

**Environment variables:**

- Database credentials, API tokens, admin JWT secrets
- Configured via `.env` files (not committed to git)

---

## 4. Shared Packages - UI Components (`packages/ui`)

**Structure:**

```
packages/ui/
├── src/
│   ├── components/
│   │   ├── Button/
│   │   ├── Card/
│   │   ├── Form/
│   │   └── index.ts
│   └── index.ts
├── package.json
├── tsconfig.json
└── vite.config.ts       # For building the package
```

**Build setup:**

- Built with Vite for fast bundling
- Exports both ESM and CommonJS formats
- TypeScript declarations generated automatically
- CSS modules or Tailwind for styling

**Package configuration:**

- Named `@repo/ui` internally
- Exports components individually: `import { Button } from '@repo/ui'`
- Development mode with hot module reload for rapid iteration
- Peer dependencies: React, React-DOM (not bundled, provided by consumer)

**Testing:**

- Vitest + React Testing Library for component tests
- Uses shared `@repo/vitest-config`

---

## 5. Shared Packages - Utils (`packages/utils`)

**Structure:**

```
packages/utils/
├── src/
│   ├── validation/
│   │   ├── schemas.ts       # Zod/Yup schemas
│   │   └── index.ts
│   ├── formatting/
│   │   ├── dates.ts         # Date formatting helpers
│   │   ├── strings.ts       # String utilities
│   │   └── index.ts
│   ├── api/
│   │   ├── strapi-client.ts # Strapi API client
│   │   ├── fetch-helpers.ts # Fetch wrappers
│   │   └── index.ts
│   ├── types/
│   │   ├── strapi.ts        # Strapi content types
│   │   ├── common.ts        # Shared types
│   │   └── index.ts
│   └── index.ts             # Main export
├── package.json
└── tsconfig.json
```

**Key features:**

- Tree-shakeable exports: `import { formatDate } from '@repo/utils/formatting'`
- Type-safe Strapi API client with proper TypeScript types
- Validation schemas usable in both frontend and backend
- No React dependencies - pure TypeScript/JavaScript

**Internal organization:**

- Subdirectories (validation/, formatting/, api/, types/) make it easy to extract into separate packages later if needed
- Each subdirectory has its own index.ts for clean exports

**Dependencies:**

- Date libraries (date-fns or dayjs), validation (zod), etc.
- Internal: `@repo/typescript-config`

---

## 6. Tooling Packages (ESLint, TypeScript, Vitest)

These packages provide shared configuration for consistency across the monorepo.

**`packages/typescript-config/`:**

```
├── base.json           # Common TS settings (strict mode, module resolution)
├── react.json          # Extends base, adds JSX support
├── node.json           # Extends base, Node.js-specific settings
└── package.json
```

Apps extend these: `"extends": "@repo/typescript-config/react.json"`

**`packages/eslint-config/`:**

```
├── base.js             # Core ESLint rules
├── react.js            # React-specific rules (hooks, a11y)
├── node.js             # Node.js rules
└── package.json
```

Includes: TypeScript ESLint, Prettier integration, import sorting.

**`packages/vitest-config/`:**

```
├── base.ts             # Shared Vitest settings
├── react.ts            # React Testing Library setup
└── package.json
```

**Benefits:**

- One place to update rules across all packages
- New packages automatically get good defaults
- Version-lock tooling dependencies centrally

---

## 7. Turborepo Pipeline Configuration

The `turbo.json` defines how tasks run across the monorepo:

```json
{
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".next/**", ".astro/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {
      "dependsOn": ["^build"]
    },
    "test": {
      "dependsOn": ["^build"]
    },
    "type-check": {
      "dependsOn": ["^build"]
    }
  }
}
```

**Key features:**

- `^build` means "build dependencies first" - so `@repo/ui` builds before apps that use it
- Parallel execution where possible (lint, test can run concurrently)
- Smart caching - skips unchanged packages
- `turbo run build` builds everything in correct order
- `turbo run dev --filter=web` runs only the Astro app + its dependencies

**Common commands:**

- `pnpm dev` - Start all apps in dev mode
- `pnpm build` - Production build of everything
- `pnpm lint` - Lint all packages
- `pnpm test` - Run all tests

---

## 8. Environment Variables & Development Workflow

**Environment variables setup:**

Each app manages its own `.env` files:

```
apps/web/.env.local          # Astro: STRAPI_API_URL, PUBLIC_SITE_URL
apps/strapi/.env             # Strapi: DATABASE_*, JWT_SECRET, API_TOKEN_SALT
```

Root `.gitignore` excludes all `.env*` files except `.env.example` templates.

**Development workflow:**

1. **First time setup:**

   ```bash
   pnpm install                    # Install all dependencies
   pnpm build                      # Build shared packages
   cd apps/strapi && pnpm develop  # Start Strapi (first run creates admin)
   pnpm dev --filter=web          # Start Astro in another terminal
   ```

2. **Daily development:**

   ```bash
   pnpm dev                        # Starts both apps concurrently
   ```

3. **Adding dependencies:**
   ```bash
   pnpm add <package> --filter=web        # Add to specific app
   pnpm add <package> -w                  # Add to root workspace
   ```

**Hot reload:**

- Changes to `@repo/ui` or `@repo/utils` automatically rebuild and reload in consuming apps
- Turborepo watch mode handles dependency tracking

---

## Design Decisions & Trade-offs

### Package Manager: pnpm

**Why:** Faster, more efficient disk usage, strict workspace resolution prevents dependency hell.

### TypeScript Config Presets

**Why:** Different apps have different needs (React vs Node.js). Presets provide consistency while allowing customization.

### SQLite for Development

**Why:** Zero setup complexity - no Docker or local database server needed. Perfect for getting started quickly. Switch to Postgres/MySQL in production.

### Subdirectories in `@repo/utils`

**Why:** Keeps the package organized and makes future extraction into separate packages easy (YAGNI but prepared).

### React for Shared UI

**Why:** Astro supports React islands, largest ecosystem, and potential Strapi admin panel customization.

---

## Next Steps

After implementation:

1. Initialize git repository and make initial commit
2. Set up CI/CD pipeline for building and testing
3. Configure deployment for Astro (Vercel, Netlify, etc.)
4. Configure deployment for Strapi (Railway, Render, self-hosted)
5. Document component usage in UI package
6. Create example blog post content types in Strapi
